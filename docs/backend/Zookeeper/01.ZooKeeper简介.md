# ZooKeeper简介

Zookeeper是一个开源的分布式的，为分布式应用提供协调服务的Apache项目，是**经典的分布式数据一致性解决方案**，致力于为分布式应用提供个高性能、高可用，且具有**严格顺序访问控制能力**的分布式协调存储服务。

- 维护配置信息
- 分布式锁服务（redis通过setnx也可以作为分布式锁，二者在结构上有一定区别）
- 集群管理
- 生成分布式唯一ID

## 应用

### 1、维护配置信息(配置中心)

java编程经常会遇到配置项，比如数据库的url、schema、user和 password等。**通常这些配置项我们会放置在配置文件中，再将配置文件放置在服务器上当需要更改配置项时，需要去服务器上修改对应的配置文件。**但是随着分布式系统的兴起，由于许多服务都需要使用到该配置文件，因此有必须**保证该配置服务的高可用性（high availability）和各台服务器上配置数据的一致性。**通常会将**配置文件部署在一个集群上**，然而一个集群动辄上千台服努器，此时如果再一台台服务器逐个修改配置文件那将是非常繁琐且危险的的操作，因此就需要一种服务，**能够高效快速且可靠地完成配置项的更改等操作，并能够保证各配置项在每台服务器上的数据一致性。**

zookeeper就可以提供这样一种服务，其**使用Zab这种一致性协议来保证一致性。**现在有很多开源项目使用zookeeper来维护配置，比如在 hbase中，客户端就是连接一个zookeeper，获得必要的 hbase集群的配置信息，然后才可以进一步操作。还有在开源的消息队列 kafka中，也使用zookeeper来维护 broker的信息。在 alibaba开源的soa框架 dubbo中也广泛的使用 zookeeper管理一些配置来实现服务治理，

![image-20210220094953286](https://gitee.com/zero049/MyNoteImages/raw/master/image-20210220094953286.png)



### 2、分布式锁服务

一个集群是一个分布式系统，由多台服务器组成。为了提高并发度和可靠性，多台服务器上运行着同一种服务。当多个服务在运行时就需要协调各服务的进度，有时候需要保证当某个服务在进行某个操作时，其他的服务都不能进行该操作，即对该操作进行加锁，如果当前机器挂掉后，释放锁并 fail over到其他的机器继续执行该服务。

![Zookeeper1](https://gitee.com/zero049/MyNoteImages/raw/master/Zookeeper1.png)



### 3、集群管理

一个集群有时会因为名种软硬件故或者网络故障，出现某些服务器掉而被移除集群，而某些服务器加入到集群中的情况，zookeeper会将这些服务器加入移出的情况通知给集群中的其他正常工作的服务器，以及时调整存储和计算等任务的分配和执行等。此外zookeeper还会对故随的服务做出诊断并尝试修复

![image-20210220104605121](https://gitee.com/zero049/MyNoteImages/raw/master/image-20210220104605121.png)

### 4、生成分布式唯一ID

**在过去的单库单表型系统中，通常可以使用数据库字段自带的auto_increment属性来自动为每条记录生成一个唯一的ID。**但是分库分表后，就无法在依靠数据库的auto_increment属性来唯一标识一条记录了。此时我们就可以**用zookeeper在分布式环境下生成全局唯一ID。**做法如下：**每次要生成一个新id时，创建一个持久<font color="red">顺序节点</font>创建操作返回的节点序号，即为新ld，然后把比自己节点小的删除即可**

## 目标

Zookeeperr致力于为分布式应用提供一个高性能、高可用，且具有严格顺序访问控制能力的分布式协调服务

### 1、高性能

Zookeeper**全量数据存储在内存中**，并直接服务于客户端的所有非事务请求，尤其适用于以读为主的应用场景

### 2、高可用

Zookeeper一般以集群的方式对外提供服务，一般3-5台机器就可以组成一个可用的 Zookeeper集群了，每台机器都会在内存中维护当前的服务器状态，并且每台机器之间都相互保持着通信。**只要集群中超过一半的机器都能够正常工作，那么整个集群就能够正常对外服务**

### 3、严格顺序访问

对于来自客户端的每个更新请求，Zookeeper都会分配一个全局唯一的递增编号，这个编号反映了所有事务操作的先后顺序



## 核心概念

Zookeeper = 文件系统 + 通知机制

![image-20201002144754604](https://gitee.com/zero049/MyNoteImages/raw/master/image-20201002144754604.png)

Zookeeper的集群中：

1）一个领导者（Leader），多个跟随者（Follower) 组成的集群

**2）集群中只要有半数以上的节点存活，Zookeeper集群就能正常服务**

3）**全局数据一致**，每个Server保存一份相同数据的副本，Client无论连接到哪个Server,数据都是一致的

4）**更新请求顺序进行**，来自同一个Client的更新请求按照其发送顺序依次执行。（发出写1、2消息，严格执行1、2的写顺序）

5）数据更新**原子性**，一次数据更新要么成功，要么失败

6）实时性，在一定的时间范围内，Client能读到最新数据



![image-20201002144821569](https://gitee.com/zero049/MyNoteImages/raw/master/image-20201002144821569.png)

## 数据结构

ZooKeeper数据模型的结构**与Uυniⅸ文件系统很类似**，整体上可以看作是一棵树，每个节点称做一个 ZNode。每—个ZNode**默认能够存储1MB**的数据，每个 ZNode都可以**通过其路径唯一标识**。（没有文件夹概念，每个节点都是ZNode）

![image-20201002145429451](https://gitee.com/zero049/MyNoteImages/raw/master/image-20201002145429451.png)





## 应用场景

提供的服务包括：统一命名服务、统一配置管理、统一集群管理、服务器节点动态上下线、软负载均衡等



**1、统一命名服务**

在分布式环境下，需要经常对应用服务器进行统一命名，便于识别

![image-20201002145826608](https://gitee.com/zero049/MyNoteImages/raw/master/image-20201002145826608.png)

**2、统一配置管理**

1. 分布式环境下，配置文件的同步非常常见
   - 一般要求一个集群中，所有节点的配置信息是一致的，比如kafka集群
   - 对一个配置文件的修改能够快速同步到各个节点上

2. 配置管理可交由Zookeeper实现
   - 可将配置信息写入Zookeeper上的一个Znode
   - 各个客户端服务器监听这个Znode
   - 一旦Znode中数据被修改，Zookeeper将通知各个客户端服务器



**3、统一集群管理：**

1. 分布式环境中，实时掌握每个节点的状态是必要的。
   - 可根据节点实时状态做出一些调整。
2. ZooKeeper可以实现实时监控节点状态变化
   - 可将节点信息写入 ZooKeeper上的一个 ZNode
   - 监听这个 ZNode可获取它的实时状态变化。

![image-20201002150011690](pictures/image-20201002150011690.png)

**4、服务器节点动态上下线**

![image-20201002150151830](https://gitee.com/zero049/MyNoteImages/raw/master/image-20201002150151830.png)

**5、软负载均衡**

![image-20201002150242196](https://gitee.com/zero049/MyNoteImages/raw/master/image-20201002150242196.png)