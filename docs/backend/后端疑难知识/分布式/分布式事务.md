# 分布式事务

## 事务

什么是事务？举个生活中的例子：你去小卖铺买东西，“一手交钱，一手交货就是一个事务的例子，交钱和交货必须全部成功，事务才算成功，任一个活动失败，事务将撤销所有已成功的活动。
明白上述例子，再来看事务的定义
**事务可以看做是一次大的活动，它由不同的小活动组成，这些活动要么全部成功，要么全部失败。**



### 本地事务

在计算机系统中，更多的是通过关系型数据库来控制事务，这是利用数据库本身的事务特性来实现的，因此叫数据库事务，由于应用主要靠关系数据库来控制事务，而数据库通常和应用在同一个服务器，所以基于关系型数据库的事务又被称为本地事务。

回顾一下数据库事务的四大特性ACID 

A（Atomic）：原子性，构成事务的所有操作，要么都执行完成，要么全部不执行，不可能出现部分成功部分失败的情况

c（Consistency）：一致性，在事务执行前后，数据库的—致性约束没有被破坏。比如：张三向李四转100元，转账前和转账后的数据是正确状态这叫一致性，如果出现张三转出100元，李四账户没有增加100元这就出现了数据错误，就没有达到一致性。

l（Isolation）：隔离性，数据库中的事务一般都是并发的，隔离性是指并发的两个事务的执行互不干扰，个事务不能看到其他事务运行过程的中间状态。通过配置事务隔离级别可以避脏读、重复读等问题

D（Durability）：持久性，事务完成之后，该事务对数据的更改会被持久化到数据库，且不会被回滚

**数据库事务在实现时会将一次事步及的所有操作全部纳入到一个不可分割的执行单元，该热行单元中的所操作要么都成功，要么都失败，只要其中任—操作执行失败，都将导致整个事务的回滚**

![image-20200520145501574](https://gitee.com/zero049/MyNoteImages/raw/master/image-20200520145501574.png)

就像之前做的项目都是基于本地事务，交给Spring管理@Transaction

但是问题在于，当用户规模越来越大，一个数据库显然是不能承载那么多数据量，就需要业务变迁进行细化拆库，就是跨库分布式事务的由来，后面还有微服务的分布式事务



### 分布式事务

随着互联网的快速发展，软件系统由原来的单体应用转变为分布式应用，下图描述了单体应用向微服务的演变

![image-20200520145818663](https://gitee.com/zero049/MyNoteImages/raw/master/image-20200520145818663.png)

分布式系统会把**一个应用系统拆分为可独立部署的多个服务**，因此需要服务与服务之间**远程协作**才能完成事务操作，这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为**分布式事务**，例如用户注册送积分事务、创建订单减库存事务，银行转账事务等都是分布式事务。



![image-20200520145636948](https://gitee.com/zero049/MyNoteImages/raw/master/image-20200520145636948.png)

<div style="text-align:center;color: #8c8c8c">跨库的分布式事务</div>



### 问题

我们知道本地事务依赖数据库本身提供的事务特性来实现，因此以下逻辑可以控制本地事务

```
begin transaction
	//1.本地数据库操作：张三减少金额
	//2.本地数据库操作：李四增加金额
commit transation
```

但是在分布式环境下，会变成下边这样：

```
begin transaction
	//1.本地数据库操作：三减少金额
	//2.远程调用：让李四增加金额
commit transation
```

可以设想，当远程调用让李四增加金额成功了，由于网络问题远程调用并没有返回，此时本地事务提交失败（超时，没拿到返回结果）就了张三减少金额的操作，此时张三和李四的数据就不一致了。

因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在一个数据库中甚至不在一个应用系统里，实现转账事务需要通过远程调用，由于网络问题就会导致分布式事务问题。

也就是说分布式事务，就是可能业务需要几个数据库一起协同操作修改（比如订单库和用户库和...要一起协同修改），这几个库在不同的fen

